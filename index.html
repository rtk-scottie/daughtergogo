<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>千千的溫馨提醒小工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: "Warm & Welcoming" - A soft, harmonious harmonious palette designed to feel supportive and calm, using warm neutrals with gentle pink and coral accents. -->
    <!-- Application Structure Plan: The application is designed as an interactive "discovery tool" featuring two main sections: "Magic Slogans" (now 4 cards) and "Dance Tips" (4 cards), plus "Magic Score", "Magic Battle", and new "Monster Collection" sections. This structure transforms simple lists into an engaging, game-like experience suitable for a 7-year-old. The user flow is: 1. See a situation. 2. Click to reveal the "magic solution" (the slogan or tip). 3. Interact with a "hug button" (or a specific action icon for dance tips) to get positive visual feedback and increment a local score. 4. In the "Magic Battle" section, the accumulated local score can be used to attack a monster with different types of attacks. When a monster is defeated, its unique emoji is added to a persistent collection. This non-linear, interactive approach was chosen to maximize engagement and memorability for a young user, making the core messages fun concepts to learn, while also providing a tangible "gamefied" element for tracking progress in the current session and cumulative collection across sessions. -->
    <!-- Visualization & Content Choices: Goal: To inform and reinforce behavioral private patterns and learning points from textual source material, and to gamify progress through a battle system and monster collection. Method: Interactive Cards (HTML/CSS) are used for slogans and dance tips. For the score and battle, simple text displays, HTML/CSS for health bars, and Unicode characters for characters are employed. A new "Collected Monsters" section uses a flexible container to display unique monster emojis, now with export/import functionality. Interaction: Clicking cards reveals text. Clicking buttons on card backs triggers particle animation, increments a session-based score. Daily limits and bonus points for completing sets of cards are managed via localStorage for daily persistence, with the fourth slogan card now having unlimited daily clicks for points and custom point input. Two "Attack" buttons in the battle section trigger different damage calculations based on current score, update monster health visually (health bar, character shake), and deduct magic points. If monster health drops to 0, it resets, and a new random monster appears. Justification: This design directly translates the report's core message into an age-appropriate, interactive format that encourages learning through play. LocalStorage provides secure data persistence for scores, monster health (daily reset), and monster collection (cumulative), now enhanced with file export/import. Library/Method: Vanilla JavaScript for interactions, Tailwind CSS for styling, and Unicode characters for icons. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .perspective {
            perspective: 1000px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            text-align: center;
            border-radius: 1.5rem;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .particle {
            position: absolute;
            opacity: 0;
            animation: float-up 1.5s ease-out forwards;
        }
        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.5);
            }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .collected-monster-icon {
            font-size: 2.5rem; /* Larger size for collected monsters */
            margin: 0.5rem; /* Spacing between monsters */
        }
    </style>
</head>
<body class="bg-[#FFF8F0] text-[#5C3A21]">

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#D96C4C]">給千千的魔法小秘訣</h1>
            <p class="mt-2 text-lg text-gray-600">當遇到下面的情況時，試著點點看卡片吧！</p>
        </header>

        <main class="w-full max-w-5xl">
            <!-- Existing Magic Slogans Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-12">

                <!-- Card 1: Work Reminder -->
                <div class="card perspective h-80 cursor-pointer" data-card="1" data-log-id="slogan-card-1">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#F4A261]">
                            <span class="text-6xl mb-4">✏️</span>
                            <h2 class="text-2xl font-bold">當媽媽提醒<br>有工作還沒做…</h2>
                        </div>
                        <div class="card-face card-back bg-[#F4A261] text-white shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">千千先給媽媽抱抱，<br>再乖乖去做。</h3>
                             <button class="hug-button mt-6 bg-white text-[#F4A261] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">💖</button>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Homework Correction -->
                <div class="card perspective h-80 cursor-pointer" data-card="2" data-log-id="slogan-card-2">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#E76F51]">
                            <span class="text-6xl mb-4">📚</span>
                            <h2 class="text-2xl font-bold">當媽媽指出<br>作業要修正…</h2>
                        </div>
                        <div class="card-face card-back bg-[#E76F51] text-white shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">千千先給媽媽抱抱，<br>再乖乖去改。</h3>
                            <button class="hug-button mt-6 bg-white text-[#E76F51] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">💖</button>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Learning to Jump -->
                <div class="card perspective h-80 cursor-pointer" data-card="3" data-log-id="slogan-card-3">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#D96C4C]">
                            <span class="text-6xl mb-4">🤸‍♀️</span>
                            <h2 class="text-2xl font-bold">當媽媽發現<br>要怎麼跳更好…</h2>
                        </div>
                        <div class="card-face card-back bg-[#D96C4C] text-white shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">千千先給媽媽抱抱，<br>再乖乖去跳。</h3>
                            <button class="hug-button mt-6 bg-white text-[#D96C4C] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">💖</button>
                        </div>
                    </div>
                </div>

                <!-- New Slogan Card 4: Deserves Reward -->
                <div class="card perspective h-80 cursor-pointer" data-card="4" data-log-id="slogan-card-4">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#A7C957]">
                            <span class="text-6xl mb-4">🏆</span>
                            <h2 class="text-2xl font-bold">當千千很棒<br>值得更多獎勵…</h2>
                        </div>
                        <div class="card-face card-back bg-[#A7C957] text-white shadow-xl flex-col">
                            <h3 class="text-xl font-bold leading-relaxed mb-4">給自己一個讚，<br>媽媽也很驕傲！</h3>
                            <input type="number" id="slogan-card-4-points" placeholder="輸入點數" class="w-24 p-2 rounded-lg text-center text-gray-800 mb-4 focus:outline-none focus:ring-2 focus:ring-white">
                            <button class="hug-button mt-auto bg-white text-[#A7C957] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">💖</button>
                        </div>
                    </div>
                </div>

            </div>

            <hr class="border-t-2 border-[#F4A261] w-full my-12">

            <!-- New Dance Tips Section -->
            <section id="dance-tips" class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-bold text-[#D96C4C] mb-4">✨ 千千的舞動小秘訣 ✨</h2>
                <p class="mt-2 text-lg text-gray-600">跳舞時，別忘了這些小重點喔！點擊卡片看看吧！</p>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8">

                <!-- Dance Card 1: Head Movement -->
                <div class="card perspective h-80 cursor-pointer" data-card="5" data-log-id="dance-tip-head">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#FFBF80]">
                            <span class="text-6xl mb-4">👤</span>
                            <h2 class="text-2xl font-bold">跳舞時<br>頭的動作</h2>
                        </div>
                        <div class="card-face card-back bg-[#FFBF80] text-[#5C3A21] shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">頭要看前面，<br>輕輕跟著動！</h3>
                            <button class="hug-button mt-6 bg-white text-[#FFBF80] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">👤</button>
                        </div>
                    </div>
                </div>

                <!-- Dance Card 2: Body Movement -->
                <div class="card perspective h-80 cursor-pointer" data-card="6" data-log-id="dance-tip-body">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#B36A45]">
                            <span class="text-6xl mb-4">💃</span>
                            <h2 class="text-2xl font-bold">跳舞時<br>身體的動作</h2>
                        </div>
                        <div class="card-face card-back bg-[#B36A45] text-white shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">身體要直挺，<br>扭扭更有力！</h3>
                            <button class="hug-button mt-6 bg-white text-[#B36A45] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">💃</button>
                        </div>
                    </div>
                </div>

                <!-- Dance Card 3: Hand Movement -->
                <div class="card perspective h-80 cursor-pointer" data-card="7" data-log-id="dance-tip-hand">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#7A4C3C]">
                            <span class="text-6xl mb-4">👋</span>
                            <h2 class="text-2xl font-bold">跳舞時<br>手的動作</h2>
                        </div>
                        <div class="card-face card-back bg-[#7A4C3C] text-white shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">手兒要伸開，<br>像小鳥飛翔！</h3>
                            <button class="hug-button mt-6 bg-white text-[#7A4C3C] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">👋</button>
                        </div>
                    </div>
                </div>

                <!-- Dance Card 4: Foot Movement -->
                <div class="card perspective h-80 cursor-pointer" data-card="8" data-log-id="dance-tip-foot">
                    <div class="card-inner">
                        <div class="card-face bg-white shadow-xl border-4 border-[#CC926F]">
                            <span class="text-6xl mb-4">👣</span>
                            <h2 class="text-2xl font-bold">跳舞時<br>腳的動作</h2>
                        </div>
                        <div class="card-face card-back bg-[#CC926F] text-white shadow-xl">
                            <h3 class="text-xl font-bold leading-relaxed">腳步輕又快，<br>跳出好節奏！</h3>
                            <button class="hug-button mt-6 bg-white text-[#CC926F] rounded-full p-3 text-3xl transform hover:scale-110 transition-transform">👣</button>
                        </div>
                    </div>
                </div>

            </div>

            <hr class="border-t-2 border-[#F4A261] w-full my-12">

            <!-- Score Section -->
            <section id="magic-score" class="text-center bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300 mb-8">
                <h2 class="text-3xl md:text-4xl font-bold text-[#D96C4C] mb-4">✨ 千千的魔法點數 ✨</h2>
                <p class="text-lg text-gray-600 mb-2">妳已經點亮魔法：</p>
                <div class="flex items-center justify-center">
                    <span id="score-display" class="text-6xl md:text-7xl font-bold text-[#F4A261] drop-shadow-md">0</span>
                    <span class="text-4xl text-[#D96C4C] ml-2">次！</span>
                </div>
                <p id="bonus-message" class="text-lg text-green-600 font-bold mt-4 min-h-[1.5em]"></p>
            </section>

            <!-- Magic Battle Section -->
            <section id="magic-battle" class="text-center bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
                <h2 class="text-3xl md:text-4xl font-bold text-[#D96C4C] mb-4">⚔️ 魔法對戰！ ⚔️</h2>
                <p class="text-lg text-gray-600 mb-6">運用妳的魔法點數，打敗小怪獸吧！</p>

                <div class="flex flex-col sm:flex-row items-center justify-center gap-6 mb-6">
                    <!-- Warrior -->
                    <div class="flex flex-col items-center">
                        <span class="text-6xl">🦸‍♀️</span>
                        <p class="text-xl font-bold text-[#5C3A21] mt-2">小勇士</p>
                    </div>

                    <!-- Versus -->
                    <span class="text-5xl text-[#F4A261] font-bold">VS</span>

                    <!-- Monster -->
                    <div class="flex flex-col items-center">
                        <span id="monster-character" class="text-6xl">👾</span>
                        <p class="text-xl font-bold text-[#5C3A21] mt-2">小怪獸</p>
                        <div class="w-40 h-6 bg-gray-300 rounded-full mt-2 relative overflow-hidden shadow-inner">
                            <div id="monster-health-inner" class="absolute inset-0 bg-green-500 rounded-full transition-all duration-300"></div>
                            <span id="monster-health-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white text-shadow-sm">100/100</span>
                        </div>
                    </div>
                </div>

                <p id="attack-message" class="text-lg text-[#D96C4C] mb-4">去攻擊它吧！</p>

                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="dragon-claw-button" class="bg-[#2A9D8F] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-[#264653] transition-colors transform hover:scale-105">
                        ⚡ 龍爪 (消耗2點)
                    </button>
                    <button id="destruction-ray-button" class="bg-[#E76F51] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-[#D96C4C] transition-colors transform hover:scale-105">
                        🔥 破壞死光 (消耗10點)
                    </button>
                </div>
                
                <div class="mt-4">
                    <button id="reset-monster-button" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-gray-500 transition-colors hidden">
                        重置怪獸
                    </button>
                </div>
            </section>

            <hr class="border-t-2 border-[#F4A261] w-full my-12">

            <!-- Monster Collection Section -->
            <section id="monster-collection" class="text-center bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300 mb-8">
                <h2 class="text-3xl md:text-4xl font-bold text-[#D96C4C] mb-4">👾 怪獸收集盒 👾</h2>
                <p class="text-lg text-gray-600 mb-4">妳已經打敗並收藏了這些怪獸：</p>
                <div id="collected-monsters-display" class="flex flex-wrap justify-center items-center gap-2">
                    <!-- Collected monster emojis will be displayed here -->
                    <p class="text-gray-500 text-sm" id="empty-collection-message">還沒有收藏任何怪獸喔！</p>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                    <button id="export-collection-button" class="bg-[#4CAF50] text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-[#45a049] transition-colors">
                        📦 匯出收集盒
                    </button>
                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                    <button id="import-collection-button" class="bg-[#2196F3] text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-[#1976D2] transition-colors">
                        📥 匯入收集盒
                    </button>
                </div>
            </section>

        </main>
        
        <footer class="text-center mt-12">
            <p class="text-gray-500">一個充滿愛與鼓勵的小工具 ❤️</p>
        </footer>

    </div>

    <script>
        // Local variables for score and monster health
        let currentScore = 0;
        let monsterHealth = 100;

        // Local storage keys
        const LAST_RESET_DATE_KEY = 'last_reset_date';
        const SLOGAN_CLICKS_KEY = 'slogan_clicks_today';
        const DANCE_CLICKS_KEY = 'dance_clicks_today';
        const SLOGAN_BONUS_AWARDED_KEY = 'slogan_bonus_awarded_today';
        const DANCE_BONUS_AWARDED_KEY = 'dance_bonus_awarded_today';
        const CURRENT_SCORE_KEY = 'current_score';
        const MONSTER_HEALTH_KEY = 'monster_health';
        const COLLECTED_MONSTERS_KEY = 'collected_monsters'; // New key for collected monsters
        const LAST_MONSTER_EMOJI_KEY = 'last_monster_emoji'; // Key to save the current monster emoji

        // Card IDs for bonus checks
        const SLOGAN_CARD_IDS = ['slogan-card-1', 'slogan-card-2', 'slogan-card-3', 'slogan-card-4'];
        const DANCE_CARD_IDS = ['dance-tip-head', 'dance-tip-body', 'dance-tip-hand', 'dance-tip-foot'];

        // Excluded from daily click limit (e.g., slogan-card-4)
        const UNLIMITED_CLICK_CARDS = ['slogan-card-4']; 

        let clickedSloganCardsToday = new Set();
        let clickedDanceCardsToday = new Set();
        let sloganBonusAwarded = false;
        let danceBonusAwarded = false;
        let collectedMonsters = new Set(); // New Set for collected monsters

        // List of monster emojis (more than 100 for variety)
        const MONSTER_EMOJIS = [
            '👾', '👽', '👻', '👺', '👹', '💀', '🤡', '🤖', '🎃', '😈',
            '🦠', '🐉', '🦖', '🦈', '🦀', '🦂', '🕷️', '🦗', '🐍', '🐙',
            '🐌', '🦋', '🐛', '🐝', '🐞', '🐠', '🐡', '🐢', '🐊', '🦍',
            '🐅', '🐆', '🦓', '🦌', '🐪', '🦒', '🐘', '🦏', '🦛', '🐁',
            '🐀', '🐹', '🐰', '🐻', '🐼', '🐨', '🐯', '�', '🐮', '🐷',
            '🐸', '🐒', '🐶', '🐺', '🦊', '🐱', '🐈', '🐎', '🦄', '🐔',
            '🐧', '🐦', '🐥', '🦆', '🦅', '🦉', '🦇', '🐗', '🐺', '🐲',
            '🐾', '🦉', '🦋', '🦑', '🐛', '🦖', '🦕', '🦂', '🦗', '🕷️',
            '🐍', '🦎', '🐙', '🦀', '🐡', '🐠', '🐳', '🐬', '🐾', '🐓',
            '🐈‍⬛', '🐩', '🦝', '🦨', '🦡', '🦦', '🦥', '🦦', '🦩', '🦜',
            '🦢', '🕊️', '🦃', '🦚', '🦜', '🦩', '🦉', '🦢', '🦭', '🦧',
            '🦫', '🦨', '🦡', '🦩', '🦜', '🦢', '🕊️', '🦃', '🦚', '🦢',
            '💯', '✨', '🌟', '🌈', '⚡', '🔥', '💧', '🌿', '🍄', '🌳', // Add some non-animal/non-monster for more variety
            '🍀', '🍎', '🍓', '🍒', '🍑', '🍍', '🍉', '🥝', '🥭', '🍐' // More non-monster to reach well over 100
        ];

        function getRandomMonsterEmoji() {
            return MONSTER_EMOJIS[Math.floor(Math.random() * MONSTER_EMOJIS.length)];
        }

        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().slice(0, 10); //YYYY-MM-DD
        }

        function loadLocalData() {
            const todayDate = getTodayDateString();
            const lastResetDate = localStorage.getItem(LAST_RESET_DATE_KEY);

            // Load persistent collection first
            const storedCollectedMonsters = localStorage.getItem(COLLECTED_MONSTERS_KEY);
            if (storedCollectedMonsters) {
                collectedMonsters = new Set(JSON.parse(storedCollectedMonsters));
            }

            if (lastResetDate !== todayDate) {
                // It's a new day, reset daily data
                localStorage.setItem(LAST_RESET_DATE_KEY, todayDate);
                localStorage.removeItem(SLOGAN_CLICKS_KEY);
                localStorage.removeItem(DANCE_CLICKS_KEY);
                localStorage.removeItem(SLOGAN_BONUS_AWARDED_KEY);
                localStorage.removeItem(DANCE_BONUS_AWARDED_KEY);
                // currentScore is NOT reset here as per the user's latest request
                monsterHealth = 100; // Reset monster health for new day
                localStorage.setItem(MONSTER_HEALTH_KEY, monsterHealth.toString()); // Save reset health
                document.getElementById('monster-character').textContent = getRandomMonsterEmoji(); // Set new random monster
                localStorage.setItem(LAST_MONSTER_EMOJI_KEY, document.getElementById('monster-character').textContent); // Save this new monster
            } else {
                // Same day, load existing daily data
                currentScore = parseInt(localStorage.getItem(CURRENT_SCORE_KEY) || '0', 10);
                monsterHealth = parseInt(localStorage.getItem(MONSTER_HEALTH_KEY) || '100', 10);
                
                const storedSloganClicks = localStorage.getItem(SLOGAN_CLICKS_KEY);
                if (storedSloganClicks) {
                    clickedSloganCardsToday = new Set(JSON.parse(storedSloganClicks));
                }
                const storedDanceClicks = localStorage.getItem(DANCE_CLICKS_KEY);
                if (storedDanceClicks) {
                    clickedDanceCardsToday = new Set(JSON.parse(storedDanceClicks));
                }
                sloganBonusAwarded = localStorage.getItem(SLOGAN_BONUS_AWARDED_KEY) === 'true';
                danceBonusAwarded = localStorage.getItem(DANCE_BONUS_AWARDED_KEY) === 'true';

                // Restore current monster emoji
                const lastMonsterEmoji = localStorage.getItem(LAST_MONSTER_EMOJI_KEY);
                document.getElementById('monster-character').textContent = lastMonsterEmoji || getRandomMonsterEmoji();
            }
        }

        function saveLocalData() {
            localStorage.setItem(CURRENT_SCORE_KEY, currentScore.toString());
            localStorage.setItem(MONSTER_HEALTH_KEY, monsterHealth.toString());
            localStorage.setItem(SLOGAN_CLICKS_KEY, JSON.stringify(Array.from(clickedSloganCardsToday)));
            localStorage.setItem(DANCE_CLICKS_KEY, JSON.stringify(Array.from(clickedDanceCardsToday)));
            localStorage.setItem(SLOGAN_BONUS_AWARDED_KEY, sloganBonusAwarded.toString());
            localStorage.setItem(DANCE_BONUS_AWARDED_KEY, danceBonusAwarded.toString());
            localStorage.setItem(COLLECTED_MONSTERS_KEY, JSON.stringify(Array.from(collectedMonsters))); // Save collected monsters
            localStorage.setItem(LAST_MONSTER_EMOJI_KEY, document.getElementById('monster-character').textContent); // Save current monster emoji
        }

        function updateScoreDisplay() {
            const scoreDisplayElement = document.getElementById('score-display');
            if (scoreDisplayElement) {
                scoreDisplayElement.textContent = currentScore;
            }
        }

        function updateMonsterHealthDisplay() {
            const healthBarInner = document.getElementById('monster-health-inner');
            const healthText = document.getElementById('monster-health-text');
            const resetButton = document.getElementById('reset-monster-button');
            const dragonClawButton = document.getElementById('dragon-claw-button');
            const destructionRayButton = document.getElementById('destruction-ray-button');

            if (healthBarInner && healthText && resetButton && dragonClawButton && destructionRayButton) {
                let percentage = (monsterHealth / 100) * 100;
                if (percentage < 0) percentage = 0;
                healthBarInner.style.width = `${percentage}%`;
                healthText.textContent = `${monsterHealth}/100`;
                
                if (percentage > 50) {
                    healthBarInner.className = 'absolute inset-0 bg-green-500 rounded-full transition-all duration-300';
                } else if (percentage > 20) {
                    healthBarInner.className = 'absolute inset-0 bg-yellow-500 rounded-full transition-all duration-300';
                } else {
                    healthBarInner.className = 'absolute inset-0 bg-red-500 rounded-full transition-all duration-300';
                }

                if (monsterHealth <= 0) {
                    resetButton.classList.remove('hidden');
                    dragonClawButton.classList.add('hidden');
                    destructionRayButton.classList.add('hidden');
                } else {
                    resetButton.classList.add('hidden');
                    dragonClawButton.classList.remove('hidden');
                    destructionRayButton.classList.remove('hidden');
                }
            }
        }

        function updateCollectedMonstersDisplay() {
            const collectedMonstersDisplay = document.getElementById('collected-monsters-display');
            let emptyMessageElement = document.getElementById('empty-collection-message'); 
            
            if (collectedMonstersDisplay) {
                collectedMonstersDisplay.innerHTML = ''; // Clear current display
                if (collectedMonsters.size === 0) {
                    if (!emptyMessageElement) { 
                        emptyMessageElement = document.createElement('p');
                        emptyMessageElement.className = 'text-gray-500 text-sm';
                        emptyMessageElement.id = 'empty-collection-message';
                    }
                    emptyMessageElement.textContent = '還沒有收藏任何怪獸喔！';
                    collectedMonstersDisplay.appendChild(emptyMessageElement);
                } else {
                    if (emptyMessageElement) emptyMessageElement.remove(); 
                    collectedMonsters.forEach(emoji => {
                        const span = document.createElement('span');
                        span.className = 'collected-monster-icon';
                        span.textContent = emoji;
                        collectedMonstersDisplay.appendChild(span);
                    });
                }
            }
        }


        function resetMonster() {
            monsterHealth = 100;
            updateMonsterHealthDisplay();
            const monsterElement = document.getElementById('monster-character');
            if (monsterElement) {
                monsterElement.textContent = getRandomMonsterEmoji(); // New random monster on reset
                monsterElement.classList.remove('animate-bounce');
            }
            document.getElementById('attack-message').textContent = '去攻擊它吧！';
            saveLocalData(); // Save reset monster health and new monster emoji
        }

        function showBonusMessage(message) {
            const bonusMessageElement = document.getElementById('bonus-message');
            if (bonusMessageElement) {
                bonusMessageElement.textContent = message;
                bonusMessageElement.classList.remove('opacity-0');
                bonusMessageElement.classList.add('opacity-100');
                setTimeout(() => {
                    bonusMessageElement.classList.remove('opacity-100');
                    bonusMessageElement.classList.add('opacity-0');
                    bonusMessageElement.textContent = '';
                }, 3000);
            }
        }

        function checkSetCompletionAndAwardBonus() {
            // Slogan Bonus Check
            if (!sloganBonusAwarded) {
                // Only check for the original 3 slogan cards for the bonus
                const originalSloganCardIds = ['slogan-card-1', 'slogan-card-2', 'slogan-card-3'];
                const allOriginalSlogansClicked = originalSloganCardIds.every(id => clickedSloganCardsToday.has(id));
                if (allOriginalSlogansClicked) {
                    currentScore += 5;
                    updateScoreDisplay();
                    sloganBonusAwarded = true;
                    showBonusMessage("🎉 太棒了！妳點亮了所有魔法小秘訣，額外獲得5點魔法點數！");
                    saveLocalData();
                }
            }

            // Dance Bonus Check
            if (!danceBonusAwarded) {
                const allDancesClicked = DANCE_CARD_IDS.every(id => clickedDanceCardsToday.has(id));
                if (allDancesClicked) {
                    currentScore += 5;
                    updateScoreDisplay();
                    danceBonusAwarded = true;
                    showBonusMessage("🌟 哇！妳掌握了所有舞動小秘訣，額外獲得5點魔法點數！");
                    saveLocalData();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData(); // Load data from local storage or reset for new day
            updateScoreDisplay();
            updateMonsterHealthDisplay();
            updateCollectedMonstersDisplay(); // Initialize collected monsters display

            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                card.addEventListener('click', (event) => {
                    // Prevent card flip if the click originated from the input field
                    if (event.target.tagName === 'INPUT' && event.target.id === 'slogan-card-4-points') {
                        return; 
                    }
                    card.classList.toggle('flipped');
                });
            });

            // Prevent input field clicks from propagating to the card (to prevent unwanted flips)
            const sloganCard4PointsInput = document.getElementById('slogan-card-4-points');
            if (sloganCard4PointsInput) {
                sloganCard4PointsInput.addEventListener('click', (event) => {
                    event.stopPropagation();
                });
            }


            const hugButtons = document.querySelectorAll('.hug-button');
            hugButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    
                    const cardElement = button.closest('.card');
                    const cardId = cardElement.getAttribute('data-log-id');

                    // Handle slogan-card-4 with custom point input
                    if (cardId === 'slogan-card-4') {
                        const pointsInput = document.getElementById('slogan-card-4-points');
                        let pointsToAdd = parseInt(pointsInput.value, 10);

                        if (isNaN(pointsToAdd) || pointsToAdd <= 0) {
                            showBonusMessage("請輸入一個大於0的點數喔！");
                            return; // Stop function if input is invalid
                        }

                        currentScore += pointsToAdd; 
                        showBonusMessage(`妳獲得了 ${pointsToAdd} 點魔法點數！`);
                        pointsInput.value = ''; // Clear input after adding points

                    } else {
                        // Handle other cards with daily limit
                        let hasDailyLimit = !UNLIMITED_CLICK_CARDS.includes(cardId);
                        let alreadyClicked = false;

                        if (hasDailyLimit) {
                            let isSloganCard = SLOGAN_CARD_IDS.includes(cardId);
                            let isDanceCard = DANCE_CARD_IDS.includes(cardId);

                            if (isSloganCard && clickedSloganCardsToday.has(cardId)) {
                                alreadyClicked = true;
                            } else if (isDanceCard && clickedDanceCardsToday.has(cardId)) {
                                alreadyClicked = true;
                            }
                        }

                        if (alreadyClicked) {
                            showBonusMessage("這張卡片今天已經點過囉！");
                            return;
                        }

                        if (hasDailyLimit) {
                            if (SLOGAN_CARD_IDS.includes(cardId)) {
                                clickedSloganCardsToday.add(cardId);
                            } else if (DANCE_CARD_IDS.includes(cardId)) {
                                clickedDanceCardsToday.add(cardId);
                            }
                        }
                        currentScore++; 
                    }

                    createParticles(button.innerHTML, button); 
                    updateScoreDisplay();
                    saveLocalData(); // Save score and click state

                    checkSetCompletionAndAwardBonus();
                });
            });

            function createParticles(content, sourceElement) {
                const particleCount = 10;
                const sourceRect = sourceElement.getBoundingClientRect();
                const containerRect = document.getElementById('app-container').getBoundingClientRect();

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('span');
                    particle.innerHTML = content; 
                    particle.classList.add('particle');
                    particle.style.position = 'absolute';
                    particle.style.fontSize = `${Math.random() * 15 + 10}px`;
                    
                    const startX = sourceRect.left + sourceRect.width / 2 - containerRect.left;
                    const startY = sourceRect.top + sourceRect.height / 2 - containerRect.top;

                    particle.style.left = `${startX}px`;
                    particle.style.top = `${startY}px`;

                    const angle = Math.random() * 360;
                    const distance = Math.random() * 50 + 20;
                    
                    const endX = Math.cos(angle * Math.PI / 180) * distance;
                    const endY = Math.sin(angle * Math.PI / 180) * distance;

                    particle.style.animation = 'none';
                    particle.offsetHeight; // Trigger reflow to restart animation
                    particle.style.animation = `float-up 1.5s ease-out forwards`;
                    
                    document.getElementById('app-container').appendChild(particle);

                    setTimeout(() => {
                        particle.remove();
                    }, 1500);
                }
            }

            // Magic Battle Logic
            const dragonClawButton = document.getElementById('dragon-claw-button');
            const destructionRayButton = document.getElementById('destruction-ray-button');
            const monsterCharacter = document.getElementById('monster-character');
            const attackMessage = document.getElementById('attack-message');

            function calculateDragonClawDamage() {
                const rand = Math.random();
                if (rand < 0.10) { // 10% chance for 1 damage
                    return 1;
                } else if (rand < 0.10 + 0.45) { // 45% chance for 5 damage (0.10 + 0.45 = 0.55)
                    return 5;
                } else if (rand < 0.10 + 0.45 + 0.30) { // 30% chance for 10 damage (0.55 + 0.30 = 0.85)
                    return 10;
                } else { // 15% chance for 20 damage
                    return 20;
                }
            }

            function performAttack(damageAmount, scoreCost, attackName) {
                if (currentScore < scoreCost) {
                    attackMessage.textContent = `妳的魔法點數不足喔！需要 ${scoreCost} 點才能使用 ${attackName}。`;
                    return;
                }

                if (monsterHealth <= 0) {
                     attackMessage.textContent = '怪獸已經被打敗了！點擊「重置怪獸」按鈕重新挑戰！';
                     return;
                }

                currentScore -= scoreCost;
                updateScoreDisplay();
                
                let actualDamage = damageAmount;
                if (attackName === '龍爪') {
                    actualDamage = calculateDragonClawDamage();
                }

                monsterHealth -= actualDamage;
                if (monsterHealth < 0) {
                    monsterHealth = 0;
                }
                
                updateMonsterHealthDisplay();
                saveLocalData(); // Save monster health and updated score

                monsterCharacter.classList.add('shake');
                setTimeout(() => {
                    monsterCharacter.classList.remove('shake');
                }, 500);

                createParticles('💥', document.body); // Attack particles from center of body

                if (monsterHealth <= 0) {
                    attackMessage.textContent = `太棒了！妳用 ${attackName} 擊敗了怪獸！`;
                    const defeatedMonsterEmoji = monsterCharacter.textContent; // Get the emoji BEFORE changing text
                    monsterCharacter.textContent = ' defeated!'; // Monster shows defeated state
                    
                    showCustomConfirm('恭喜妳打敗了怪獸！要重新挑戰嗎？', () => {
                        collectedMonsters.add(defeatedMonsterEmoji); // Add to collection
                        updateCollectedMonstersDisplay(); // Update display
                        
                        resetMonster(); // Reset monster and get new random emoji
                        // currentScore is NOT reset here
                        updateScoreDisplay(); // Update display with currentScore (which is not 0)
                        // Reset bonus status for the new challenge day (if already awarded)
                        sloganBonusAwarded = false; 
                        danceBonusAwarded = false;
                        clickedSloganCardsToday.clear(); // Clear click states for new day
                        clickedDanceCardsToday.clear(); // Clear click states for new day
                        saveLocalData(); // Save all reset states and collected monsters
                    });
                } else {
                    attackMessage.textContent = `妳用 ${attackName} 造成了 ${actualDamage} 點傷害！怪獸還剩下 ${monsterHealth} 點血量。`; // Use actualDamage here
                }
            }

            dragonClawButton.addEventListener('click', () => {
                performAttack(5, 2, '龍爪'); // Pass base damage (5) for Dragon Claw, but it will be recalculated
            });

            destructionRayButton.addEventListener('click', () => {
                performAttack(50, 10, '破壞死光');
            });

            // Custom Confirm Modal (replaces window.confirm)
            function showCustomConfirm(message, onConfirm) {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modalOverlay.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                        <p class="text-xl font-bold mb-4 text-[#5C3A21]">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="custom-confirm-yes" class="bg-[#D96C4C] text-white font-bold py-2 px-4 rounded-full hover:bg-[#E76F51] transition-colors">是</button>
                            <button id="custom-confirm-no" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-full hover:bg-gray-500 transition-colors">否</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);

                document.getElementById('custom-confirm-yes').addEventListener('click', () => {
                    onConfirm();
                    modalOverlay.remove();
                });
                document.getElementById('custom-confirm-no').addEventListener('click', () => {
                    modalOverlay.remove();
                });
            }

            // Reset monster button listener
            const resetButton = document.getElementById('reset-monster-button');
            resetButton.addEventListener('click', () => {
                resetMonster();
                // currentScore is NOT reset here
                updateScoreDisplay(); // Update display with currentScore (which is not 0)
                sloganBonusAwarded = false; 
                danceBonusAwarded = false;
                clickedSloganCardsToday.clear();
                clickedDanceCardsToday.clear();
                saveLocalData();
                showBonusMessage("怪獸已重置，可以開始新的挑戰囉！"); // Message updated to reflect score not reset
            });

            // Export and Import Functionality
            const exportButton = document.getElementById('export-collection-button');
            const importButton = document.getElementById('import-collection-button');
            const importFileInput = document.getElementById('import-file-input');

            exportButton.addEventListener('click', () => {
                const data = JSON.stringify(Array.from(collectedMonsters), null, 2); // Convert Set to Array for JSON
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'monsters_collection.json'; // Suggested filename
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showBonusMessage('收集盒已匯出！請檢查您的下載項目。'); // Added more specific message
            });

            importButton.addEventListener('click', () => {
                importFileInput.click(); // Trigger file input click
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (Array.isArray(importedData)) {
                                collectedMonsters = new Set(importedData);
                                updateCollectedMonstersDisplay();
                                saveLocalData();
                                showBonusMessage('收集盒已成功匯入！');
                            } else {
                                showBonusMessage('匯入失敗：檔案格式不正確！');
                            }
                        } catch (error) {
                            console.error('Error parsing imported file:', error);
                            showBonusMessage('匯入失敗：檔案內容損壞或格式錯誤！');
                        }
                    };
                    reader.readAsText(file);
                }
            });
        });
    </script>
</body>
</html>
�